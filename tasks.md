# 任务

## Timeline

| Date  | 前端   | 中端    | 后端                   |
| ----- | ------ | ------- | ---------------------- |
| 11.24 | 符号表 | IR 设计 | MIR 设计, 寄存器分配   |
| 11.30 | -      | IR 生成 | MIR 生成，目标代码生成 |
| ...   | ...    | ...     | ...                    |

> [!TIP]
>
> ***斜体*** 内容为参考性的内容，**目前阶段**可以视情况搞。
>
> 以下内容为大致性的参考流程，描述与总结可能不够完善和准确，我们可以随时更改和添加。
>
> 完成时间为参考性的...

## 前端

> 接收SySy源代码 ⬇️

- [ ] ### 1. 词法分析&语法分析完善 ⏱️ 11.19前完成 ZS

> [!NOTE]
>
> 这部分内容在 icoding 实验基础上进行完善。

- [ ] lex.l 文件完善

- [ ] AST 结构完善

- [ ] praser.y 文件完善


- [ ] ### 2. 语义分析 ⏱️ 11.24前基本完成W&C


- [ ] **符号表生成**

遍历AST，遇到每个声明时，将符号信息记录到符号表中。

填充符号信息：根据符号类型填充符号表，包括：
- 变量：记录变量名、类型、存储类型、初始值等。
- 函数：记录函数名、返回类型、参数列表、参数类型、作用域等。

嵌套作用域处理：遇到嵌套作用域时，创建新层的符号表并关联父作用域。

> [!TIP]
>
> 测试用例应该没有语法错误，所以下面内容，包括其他一些语法错误检查，目前可以放放...

- [ ] *类型检查*
- [ ] *作用域和标识符检查*

...

## 中端

> 接收前端的 AST , 符号表 ⬇️

### 1. IR 生成

- [ ] #### IR 类的设计：⏱️ 11.19前基本完成，11.23前完成初版。ZS


- [x] 基础类：USER, USE, VALUE

- [ ] 高级类：MODULE, FUNCTION, BLOCK, INSTUCTION...

- [ ] #### IR 生成codegen ⏱️ 11.30左右 ZS


- [ ] AST遍历与指令生成：根据设计的instruction类，生成线性instruction流

  - 将AST逐节点遍历，处理每种类型节点，生成instruction，临时添加到function和module中
  - 根据符号表查找变量的信息，以确定变量的内存布局等。将声明转换为`alloca`指令，并标记其类型和作用域。
  - 拆分复杂表达式为基本运算指令。
  - 控制流语句处理。
  - 生成`call`指令用于函数调用，生成`ret`指令用于返回结果。
- [ ] 基本块划分：每当遇到条件跳转、循环等控制流变化，创建新的基本块，构建CFG
- [ ] *SSA 转换，插入phi函数*

###  2. 代码优化 W&C&ZS

活跃变量分析

数据流优化：合并已知量，常量传播，合并公共子表达式，删除无用赋值，删除死代码...

控制流优化：分支优化，不可达代码消除...

循环优化：代码外提，循环合并，强度削减...

...

## 后端

> 接收中端的 IR , 符号表 ⬇️

- [ ] ### 1. MIR 生成⏱️ 11.30前 ZY


- [ ] #### MIR设计​ ⏱️ ​11.23前 ZY


- [ ] #### 指令映射 


- 映射 IR 到目标机器指令。

- 在 MIR 中保留虚拟寄存器和基本块信息。

- 将基本块中的 phi 指令转换为适当的拷贝和寄存器操作。

- [ ] #### 栈帧管理


- 在生成的目标代码中，插入代码以保存返回地址、设置栈帧和管理局部变量的栈空间。
- 维护被调用者和调用者保存的寄存器。

- [ ] #### 分支与控制流生成


- 处理条件和无条件分支指令。
- 根据 IR 中的分支逻辑生成条件跳转和符号设置指令。

- [ ] #### 返回指令生成


- 处理返回指令，设置返回值寄存器和函数结束时的栈帧恢复。

- [ ] #### 操作数处理


- 分类并处理操作数，如立即量、全局变量、虚拟寄存器等。

- 处理内存寻址，生成适当的基址寻址和全局变量标签。

### extra: 窥孔优化

- 删除冗余指令
- 含0加减指令替换
- 乘除法使用适当的位移替换

- [ ] ### 2. 寄存器分配 ⏱️ 11.23前​ ZY


- 冲突图维护，图化简。
- 进行寄存器分配。
- 处理溢出的情况，将溢出的变量存入内存中。

- [ ] ### 3. 指令优化和指令调度

- 例：将乘除法适当的转化为位移运算和若干加减法
- 以CPU流水线为基础，通过合理排列指令，提高cache的命中率

- [ ] ### 4. 指令合法化

- 生成的ARM可能依然存在一些细节上的问题，如直接编码的立即数过长等

- [ ] ### 5. 目标代码生成 ⏱️ 11.30前 ​ZY

生成文件头信息，将最终的 MIR 转换为具体的汇编指令。

